<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LuxuryStay - Hotel Management (Tailwind + Firebase)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { padding-top: 72px; }
    .cursor-progress { cursor: progress !important; }
  </style>
</head>
<body class="bg-gray-50 font-sans">

  <!-- NAVBAR -->
  <nav class="bg-white shadow-lg fixed w-full top-0 z-50">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-blue-600">LuxuryStay</h1>
      <div class="space-x-4 hidden md:flex items-center">
        <a href="#home" class="text-gray-700 hover:text-blue-600">Home</a>
        <a href="#rooms" class="text-gray-700 hover:text-blue-600">Rooms</a>
        <a href="#book" class="text-gray-700 hover:text-blue-600">Book</a>
        <a href="#about" class="text-gray-700 hover:text-blue-600">About</a>
        <a href="#contact" class="text-gray-700 hover:text-blue-600">Contact</a>
        <button id="adminLoginBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Admin Login</button>
      </div>

      <!-- mobile menu button -->
      <div class="md:hidden">
        <button id="mobileMenuBtn" class="text-gray-700"><i class="fa-solid fa-bars"></i></button>
      </div>
    </div>
  </nav>

  <!-- Mobile menu -->
  <div id="mobileMenu" class="hidden md:hidden bg-white shadow-sm fixed top-16 left-0 right-0 z-40">
    <div class="p-4 space-y-2">
      <a href="#home" class="block text-gray-700">Home</a>
      <a href="#rooms" class="block text-gray-700">Rooms</a>
      <a href="#book" class="block text-gray-700">Book</a>
      <a href="#about" class="block text-gray-700">About</a>
      <a href="#contact" class="block text-gray-700">Contact</a>
      <button id="adminLoginBtnMobile" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg">Admin Login</button>
    </div>
  </div>

  <!-- HERO -->
  <section id="home" class="pt-8 bg-gradient-to-r from-blue-50 to-white text-center py-16">
    <div class="container mx-auto px-6">
      <h2 class="text-4xl font-bold text-gray-800 mb-4">Experience the Luxury You Deserve</h2>
      <p class="text-gray-600 mb-8">Relax, unwind, and enjoy your stay with world-class amenities.</p>
      <div class="flex justify-center gap-4">
        <a href="#book" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">Book Your Stay</a>
        <a href="#rooms" class="border border-blue-600 text-blue-600 px-6 py-3 rounded-lg hover:bg-blue-600 hover:text-white transition">View Rooms</a>
      </div>
      <div class="mt-10 flex justify-center">
        <img src="https://images.unsplash.com/photo-1578683010236-d716f9a3f461?auto=format&fit=crop&w=1400&q=80" class="rounded-2xl shadow-2xl w-full max-w-4xl">
      </div>
    </div>
  </section>

  <!-- MAIN LAYOUT -->
  <main class="container mx-auto px-6 py-10 grid md:grid-cols-3 gap-8">

    <!-- Booking & Rooms -->
    <div class="md:col-span-2 space-y-8">

      <!-- Booking Form -->
      <section id="book" class="bg-white p-8 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Book Your Stay</h2>

        <form id="bookingForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-gray-700 mb-2">Customer Name</label>
            <input id="customerName" required class="w-full border-gray-300 rounded-lg p-3" placeholder="Full name">
          </div>

          <div class="col-span-2">
            <label class="block text-gray-700 mb-2">Customer Email</label>
            <input id="customerEmail" type="email" required class="w-full border-gray-300 rounded-lg p-3" placeholder="you@domain.com">
          </div>

          <div>
            <label class="block text-gray-700 mb-2">Check-in Date</label>
            <input id="checkInDate" type="date" class="w-full border-gray-300 rounded-lg p-3">
          </div>
          <div>
            <label class="block text-gray-700 mb-2">Check-out Date</label>
            <input id="checkOutDate" type="date" class="w-full border-gray-300 rounded-lg p-3">
          </div>

          <div>
            <label class="block text-gray-700 mb-2">Guests</label>
            <input id="guestNumber" type="number" min="1" value="1" class="w-full border-gray-300 rounded-lg p-3">
          </div>

          <div>
            <label class="block text-gray-700 mb-2">Room Type</label>
            <select id="roomType" class="w-full border-gray-300 rounded-lg p-3">
              <option value="deluxe" data-price="200">Deluxe Room — $200/night</option>
              <option value="executive" data-price="350">Executive Suite — $350/night</option>
              <option value="presidential" data-price="500">Presidential Suite — $500/night</option>
            </select>
          </div>

          <div class="col-span-2">
            <label class="block text-gray-700 mb-2">Room Per Night ($)</label>
            <input id="roomPerNight" type="number" min="0" step="0.01" class="w-full border-gray-300 rounded-lg p-3">
          </div>

          <div class="col-span-2">
            <label class="block text-gray-700 mb-2">Guest Satisfaction (optional)</label>
            <select id="guestSatisfaction" class="w-full border-gray-300 rounded-lg p-3">
              <option value="pending">Pending</option>
              <option value="excellent">Excellent</option>
              <option value="good">Good</option>
              <option value="average">Average</option>
              <option value="poor">Poor</option>
            </select>
          </div>

          <!-- Booking summary -->
          <div id="bookingSummary" class="col-span-2 hidden mt-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-lg">
            <div class="flex justify-between">
              <div>
                <div class="text-sm opacity-90">Nights</div>
                <div id="summaryNights" class="text-xl font-bold">0</div>
              </div>
              <div>
                <div class="text-sm opacity-90">Guests</div>
                <div id="summaryGuests" class="text-xl font-bold">1</div>
              </div>
              <div>
                <div class="text-sm opacity-90">Rate/Night</div>
                <div id="summaryRate" class="text-xl font-bold">$0</div>
              </div>
              <div>
                <div class="text-sm opacity-90">Total</div>
                <div id="summaryTotal" class="text-xl font-bold">$0</div>
              </div>
            </div>
          </div>

          <div class="col-span-2">
            <button id="addBookingBtn" type="button" class="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Confirm Booking</button>
          </div>
        </form>
      </section>

      <!-- Rooms / Features -->
      <section id="rooms" class="bg-white p-8 rounded-xl shadow">
        <h2 class="text-2xl font-bold mb-4">Rooms & Features</h2>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="p-4 border rounded-lg">
            <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?auto=format&fit=crop&w=800&q=80" class="rounded-md mb-3 w-full h-36 object-cover">
            <h3 class="font-semibold">Deluxe Room</h3>
            <p class="text-sm text-gray-600">$200 / night</p>
          </div>
          <div class="p-4 border rounded-lg">
            <img src="https://images.unsplash.com/photo-1600585154207-526cd06f6580?auto=format&fit=crop&w=800&q=80" class="rounded-md mb-3 w-full h-36 object-cover">
            <h3 class="font-semibold">Executive Suite</h3>
            <p class="text-sm text-gray-600">$350 / night</p>
          </div>
          <div class="p-4 border rounded-lg">
            <img src="https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80" class="rounded-md mb-3 w-full h-36 object-cover">
            <h3 class="font-semibold">Presidential</h3>
            <p class="text-sm text-gray-600">$500 / night</p>
          </div>
        </div>
      </section>

    </div>

    <!-- ADMIN PANEL -->
    <aside id="adminPanel" class="hidden bg-white p-6 rounded-xl shadow space-y-4">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-blue-600">Admin Dashboard</h2>
        <div>
          <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">Logout</button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div class="p-4 bg-blue-50 rounded-lg text-center">
          <div class="text-sm text-gray-600">Total Bookings</div>
          <div id="totalBookings" class="text-2xl font-bold text-blue-600">0</div>
        </div>
        <div class="p-4 bg-green-50 rounded-lg text-center">
          <div class="text-sm text-gray-600">Total Revenue</div>
          <div id="totalRevenue" class="text-2xl font-bold text-green-600">$0</div>
        </div>
        <div class="p-4 bg-purple-50 rounded-lg text-center">
          <div class="text-sm text-gray-600">Total Nights</div>
          <div id="totalNights" class="text-2xl font-bold text-purple-600">0</div>
        </div>
        <div class="p-4 bg-yellow-50 rounded-lg text-center">
          <div class="text-sm text-gray-600">Total Guests</div>
          <div id="totalGuests" class="text-2xl font-bold text-yellow-600">0</div>
        </div>
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">Rooms Available (for RevPAR calc)</label>
        <input id="roomsAvailable" type="number" min="1" value="120" class="w-full border-gray-300 rounded-lg p-2">
      </div>

      <div class="mt-2">
        <div class="text-sm text-gray-600">ADR</div>
        <div id="adrValue" class="text-xl font-bold">$0</div>
        <div class="text-sm text-gray-600 mt-2">RevPAR</div>
        <div id="revparValue" class="text-xl font-bold">$0</div>
      </div>

      <div>
        <h3 class="text-sm font-semibold text-gray-700 mt-3">Revenue (last 30 days)</h3>
        <canvas id="revenueChart" height="150"></canvas>
      </div>

      <div>
        <h3 class="text-sm font-semibold text-gray-700 mt-3">Bookings</h3>
        <div class="max-h-48 overflow-auto mt-2 border rounded-lg p-2">
          <table class="w-full text-sm">
            <thead class="text-left">
              <tr><th>Customer</th><th class="text-right">Total</th><th></th></tr>
            </thead>
            <tbody id="bookingsList">
              <tr><td colspan="3" class="text-center text-gray-500 py-4">No bookings yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </aside>

  </main>

  <!-- ABOUT -->
  <section id="about" class="container mx-auto px-6 py-8">
    <div class="bg-white p-8 rounded-xl shadow">
      <h2 class="text-2xl font-bold mb-4">About LuxuryStay</h2>
      <p class="text-gray-600">LuxuryStay has been redefining premium hospitality since 2010. With top-tier facilities and unmatched service quality, we ensure every stay becomes a cherished memory.</p>
    </div>
  </section>

  <!-- CONTACT -->
  <section id="contact" class="container mx-auto px-6 py-8">
    <div class="bg-white p-8 rounded-xl shadow">
      <h2 class="text-2xl font-bold mb-4">Contact Us</h2>
      <form id="contactForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input placeholder="Your name" class="p-3 border rounded-lg" />
        <input placeholder="Your email" class="p-3 border rounded-lg" />
        <textarea placeholder="Message" rows="4" class="p-3 border rounded-lg md:col-span-2"></textarea>
        <button class="bg-blue-600 text-white py-2 rounded-lg md:col-span-2">Send Message</button>
      </form>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="bg-gray-800 text-white py-6 mt-10">
    <div class="container mx-auto text-center">
      <p>&copy; 2025 LuxuryStay. All Rights Reserved.</p>
    </div>
  </footer>

  <!-- ADMIN LOGIN MODAL (local credential check: admin / 1234) -->
  <div id="adminModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl p-6 w-96 relative">
      <button id="closeAdminModal" class="absolute right-3 top-3 text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark"></i></button>
      <h3 class="text-xl font-bold text-center mb-4">Admin Login</h3>

      <form id="adminLoginForm" class="space-y-3">
        <input id="adminUsername" type="text" placeholder="Username" required class="w-full p-3 rounded-lg border" value="admin">
        <input id="adminPassword" type="password" placeholder="Password" required class="w-full p-3 rounded-lg border" value="1234">
        <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg">Sign in</button>
      </form>

      <p class="text-xs text-gray-500 mt-3">Default admin credentials: <strong>admin</strong> / <strong>1234</strong></p>
    </div>
  </div>

  <!-- Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    /*************************************************************************
     * FIREBASE CONFIG - using the project details you provided earlier.
     * If you want to use another Firebase project, replace this object.
     *************************************************************************/
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDN9-FOx1bMMTmGaHpsvt7MO0eZbJF0mVw",
      authDomain: "luxurystay-f4d48.firebaseapp.com",
      databaseURL: "https://luxurystay-f4d48-default-rtdb.firebaseio.com",
      projectId: "luxurystay-f4d48",
      storageBucket: "luxurystay-f4d48.firebasestorage.app",
      messagingSenderId: "957241383544",
      appId: "1:957241383544:web:a8a95c3e528717d6a92b8d",
      measurementId: "G-PSBW82LPQ8"
    };

    // Initialize Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();

    // Elements
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLoginBtnMobile = document.getElementById('adminLoginBtnMobile');
    const adminModal = document.getElementById('adminModal');
    const closeAdminModal = document.getElementById('closeAdminModal');
    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminPanel = document.getElementById('adminPanel');
    const logoutBtn = document.getElementById('logoutBtn');

    const addBookingBtn = document.getElementById('addBookingBtn');
    const bookingForm = document.getElementById('bookingForm');
    const roomTypeEl = document.getElementById('roomType');
    const roomPerNightEl = document.getElementById('roomPerNight');
    const checkInEl = document.getElementById('checkInDate');
    const checkOutEl = document.getElementById('checkOutDate');
    const guestNumberEl = document.getElementById('guestNumber');
    const bookingSummaryEl = document.getElementById('bookingSummary');
    const summaryNightsEl = document.getElementById('summaryNights');
    const summaryGuestsEl = document.getElementById('summaryGuests');
    const summaryRateEl = document.getElementById('summaryRate');
    const summaryTotalEl = document.getElementById('summaryTotal');

    const totalBookingsEl = document.getElementById('totalBookings');
    const totalRevenueEl = document.getElementById('totalRevenue');
    const totalNightsEl = document.getElementById('totalNights');
    const totalGuestsEl = document.getElementById('totalGuests');
    const roomsAvailableEl = document.getElementById('roomsAvailable');
    const adrValueEl = document.getElementById('adrValue');
    const revparValueEl = document.getElementById('revparValue');
    const bookingsListEl = document.getElementById('bookingsList');
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');

    let revenueChart = null;
    const DAYS_RANGE = 30;

    // admin modal open/close handlers
    adminLoginBtn.addEventListener('click', () => adminModal.classList.remove('hidden'));
    adminLoginBtnMobile && adminLoginBtnMobile.addEventListener('click', () => adminModal.classList.remove('hidden'));
    closeAdminModal.addEventListener('click', () => adminModal.classList.add('hidden'));
    window.addEventListener('click', (e) => { if (e.target === adminModal) adminModal.classList.add('hidden'); });

    // set initial room price
    function setRoomPriceFromType() {
      const opt = roomTypeEl.options[roomTypeEl.selectedIndex];
      const p = opt.getAttribute('data-price') || '0';
      roomPerNightEl.value = p;
      calculateStayDetails();
    }
    roomTypeEl.addEventListener('change', setRoomPriceFromType);

    [checkInEl, checkOutEl, roomPerNightEl, guestNumberEl].forEach(el => el.addEventListener('input', calculateStayDetails));

    function calculateStayDetails() {
      const checkIn = checkInEl.value;
      const checkOut = checkOutEl.value;
      const roomPerNight = parseFloat(roomPerNightEl.value) || 0;
      const guestNumber = parseInt(guestNumberEl.value) || 1;
      if (!checkIn || !checkOut || roomPerNight <= 0 || guestNumber <= 0) {
        bookingSummaryEl.classList.add('hidden');
        return null;
      }
      const ci = new Date(checkIn);
      const co = new Date(checkOut);
      const diff = co - ci;
      const nights = Math.ceil(diff / (1000 * 60 * 60 * 24));
      if (nights <= 0) { bookingSummaryEl.classList.add('hidden'); return null; }
      const totalPrice = roomPerNight * nights * guestNumber;
      summaryNightsEl.textContent = nights;
      summaryGuestsEl.textContent = guestNumber;
      summaryRateEl.textContent = '$' + roomPerNight.toFixed(2);
      summaryTotalEl.textContent = '$' + totalPrice.toFixed(2);
      bookingSummaryEl.classList.remove('hidden');
      return { nights, guestNumber, totalPrice };
    }

    // Save booking to Realtime DB
    addBookingBtn.addEventListener('click', () => {
      const customerName = document.getElementById('customerName').value.trim();
      const customerEmail = document.getElementById('customerEmail').value.trim();
      const checkInDate = checkInEl.value;
      const checkOutDate = checkOutEl.value;
      const roomType = roomTypeEl.value;
      const roomPerNight = parseFloat(roomPerNightEl.value) || 0;
      const guestNumber = parseInt(guestNumberEl.value) || 1;
      const guestSatisfaction = document.getElementById('guestSatisfaction').value;

      if (!customerName || !customerEmail || !checkInDate || !checkOutDate || !roomPerNight || !guestNumber) {
        alert('Please fill all required fields.');
        return;
      }

      const stay = calculateStayDetails();
      if (!stay) { alert('Check-out must be after check-in.'); return; }

      const bookingData = {
        customer_name: customerName,
        customer_email: customerEmail,
        check_in_date: checkInDate,
        check_out_date: checkOutDate,
        room_type: roomType,
        room_per_night: roomPerNight,
        spend_nights: stay.nights,
        guest_number: guestNumber,
        guest_satisfaction: guestSatisfaction,
        total_price: stay.totalPrice,
        booking_timestamp: new Date().toISOString(),
        status: 'confirmed'
      };

      addBookingBtn.classList.add('opacity-60', 'cursor-progress');
      db.ref('bookings').push(bookingData)
        .then(() => {
          alert('Booking saved successfully!');
          bookingForm.reset();
          setRoomPriceFromType();
          bookingSummaryEl.classList.add('hidden');
        })
        .catch(err => {
          console.error(err);
          alert('Error saving booking: ' + err.message);
        })
        .finally(() => addBookingBtn.classList.remove('opacity-60', 'cursor-progress'));
    });

    // Admin login (local check: username admin / password 1234)
    adminLoginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const u = document.getElementById('adminUsername').value.trim();
      const p = document.getElementById('adminPassword').value.trim();
      if (u === 'admin' && p === '1234') {
        adminModal.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        // start listening for bookings
        startRealtimeBookings();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        alert('Invalid credentials. Use admin / 1234');
      }
    });

    // logout simply hides admin panel and detaches listeners
    logoutBtn.addEventListener('click', () => {
      adminPanel.classList.add('hidden');
      stopRealtimeBookings();
      clearStatsUI();
      if (revenueChart) { revenueChart.destroy(); revenueChart = null; }
      alert('Logged out');
    });

    // listeners reference for detach
    let bookingsListener = null;

    function startRealtimeBookings() {
      if (bookingsListener) return; // already listening
      bookingsListener = db.ref('bookings');
      bookingsListener.on('value', snapshot => {
        const val = snapshot.val();
        const bookings = val ? Object.entries(val).map(([id, data]) => ({ id, ...data })) : [];
        renderBookingsList(bookings);
        computeAndRenderStats(bookings);
        renderRevenueChart(bookings);
      });
    }

    function stopRealtimeBookings() {
      if (!bookingsListener) return;
      bookingsListener.off();
      bookingsListener = null;
    }

    // render bookings list for admin (small)
    function renderBookingsList(bookings) {
      bookingsListEl.innerHTML = '';
      if (!bookings.length) {
        bookingsListEl.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No bookings yet</td></tr>';
        return;
      }
      bookings.slice().reverse().forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(b.customer_name)}</td>
          <td class="text-right font-semibold">$${Number(b.total_price || 0).toFixed(2)}</td>
          <td class="text-right"><button data-id="${b.id}" class="deleteBookingBtn text-red-600 hover:underline">Delete</button></td>
        `;
        bookingsListEl.appendChild(tr);
      });

      // attach delete handlers
      Array.from(document.querySelectorAll('.deleteBookingBtn')).forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          if (!confirm('Delete booking?')) return;
          db.ref('bookings/' + id).remove().catch(err => alert('Delete failed: ' + err.message));
        };
      });
    }

    // compute stats and update UI
    function computeAndRenderStats(bookings) {
      const totalBookings = bookings.length;
      let totalRevenue = 0;
      let totalNights = 0;
      let totalGuests = 0;

      bookings.forEach(b => {
        totalRevenue += Number(b.total_price || 0);
        totalNights += Number(b.spend_nights || 0);
        totalGuests += Number(b.guest_number || 0) || 1;
      });

      totalBookingsEl.textContent = totalBookings;
      totalRevenueEl.textContent = '$' + totalRevenue.toFixed(2);
      totalNightsEl.textContent = totalNights;
      totalGuestsEl.textContent = totalGuests;

      const adr = totalNights > 0 ? (totalRevenue / totalNights) : 0;
      adrValueEl.textContent = '$' + adr.toFixed(2);

      const roomsAvailable = parseInt(roomsAvailableEl.value) || 1;
      const revpar = (roomsAvailable > 0) ? (totalRevenue / (roomsAvailable * DAYS_RANGE)) : 0;
      revparValueEl.textContent = '$' + revpar.toFixed(2);
    }

    // revenue chart built from bookings by check_in_date (last 30 days)
    function renderRevenueChart(bookings) {
      const days = [];
      const now = new Date();
      for (let i = DAYS_RANGE - 1; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        days.push(formatDateKey(d)); // YYYY-MM-DD
      }

      const revenueByDay = {};
      days.forEach(k => revenueByDay[k] = 0);

      bookings.forEach(b => {
        let key = b.check_in_date || (b.booking_timestamp ? formatDateKey(new Date(b.booking_timestamp)) : null);
        if (!key) return;
        if (revenueByDay.hasOwnProperty(key)) revenueByDay[key] += Number(b.total_price || 0);
      });

      const labels = days.map(k => k.slice(5)); // MM-DD
      const data = days.map(k => revenueByDay[k] || 0);

      if (revenueChart) {
        revenueChart.data.labels = labels;
        revenueChart.data.datasets[0].data = data;
        revenueChart.update();
      } else {
        revenueChart = new Chart(revenueCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Revenue',
              data,
              tension: 0.25,
              fill: true,
              backgroundColor: 'rgba(59,130,246,0.15)',
              borderColor: '#2563eb',
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    }

    // utility functions
    function formatDateKey(d) {
      if (!(d instanceof Date)) d = new Date(d);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${dd}`;
    }
    function escapeHtml(text) {
      if (!text) return '';
      return String(text).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    // clear stats UI
    function clearStatsUI() {
      totalBookingsEl.textContent = '0';
      totalRevenueEl.textContent = '$0';
      totalNightsEl.textContent = '0';
      totalGuestsEl.textContent = '0';
      adrValueEl.textContent = '$0';
      revparValueEl.textContent = '$0';
      bookingsListEl.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No bookings yet</td></tr>';
    }

    // When roomsAvailable changes, recompute stats using a one-time DB snapshot
    roomsAvailableEl.addEventListener('input', () => {
      db.ref('bookings').once('value').then(s => {
        const val = s.val();
        const bookings = val ? Object.entries(val).map(([id, data]) => ({ id, ...data })) : [];
        computeAndRenderStats(bookings);
        renderRevenueChart(bookings);
      });
    });

    // set default dates on load
    (function setDefaultDates() {
      const today = new Date();
      const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0'), d = String(today.getDate()).padStart(2,'0');
      const inDate = `${y}-${m}-${d}`;
      const outDate = new Date(today);
      outDate.setDate(outDate.getDate() + 1);
      const y2 = outDate.getFullYear(), m2 = String(outDate.getMonth()+1).padStart(2,'0'), d2 = String(outDate.getDate()).padStart(2,'0');
      document.getElementById('checkInDate').value = inDate;
      document.getElementById('checkOutDate').value = `${y2}-${m2}-${d2}`;
      setRoomPriceFromType();
      calculateStayDetails();
    })();

  </script>

</body>
</html>
